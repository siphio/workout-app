# Feature: Phase 4 PWA & Polish - Clean Gains Workout App

The following plan should be complete, but validate documentation and codebase patterns before implementing.

Pay special attention to naming of existing utils, types, and models. Import from the right files.

---

## Feature Description

Implement Progressive Web App (PWA) functionality for the Clean Gains workout tracker, including service worker with offline caching, push notifications for rest timer completion, app icons for installation, and UI polish to match design mockups. This phase transforms the web app into a fully installable, offline-capable PWA optimized for iPhone 16 Pro Max (430Ã—932 viewport).

## User Story

As Marley using Clean Gains at the gym
I want the app to work offline, notify me when rest is over, and install to my home screen
So that I can track workouts reliably without network issues and stay focused on training

## Problem Statement

The current Clean Gains app requires network connectivity and lacks:
- Service worker for offline asset caching
- Push notifications when rest timer completes (critical for gym use)
- App icons required for home screen installation
- Sound file for timer completion audio
- Full visual polish matching the design mockups

## Solution Statement

Implement Phase 4 by:
1. Installing and configuring @serwist/next for service worker generation
2. Creating app icons (192px, 512px) for PWA installation
3. Adding timer completion sound file
4. Implementing push notification support for rest timer
5. Creating offline fallback page
6. Adding service worker registration with notification permission flow
7. Validating UI against design mockups and fixing polish issues
8. Ensuring 44Ã—44pt touch targets throughout

## Feature Metadata

**Feature Type**: Enhancement
**Estimated Complexity**: Medium-High
**Primary Systems Affected**: PWA infrastructure, Rest timer, Settings, Asset pipeline
**Dependencies**: @serwist/next, serwist, web-push (optional for advanced notifications)

---

## CONTEXT REFERENCES

### Relevant Codebase Files - MUST READ BEFORE IMPLEMENTING

| File | Lines | Purpose |
|------|-------|---------|
| `src/features/workout/hooks/use-rest-timer.ts` | 1-60 | Timer hook with sound/vibration - ADD notification trigger |
| `src/features/workout/components/rest-timer.tsx` | 1-35 | Timer UI component |
| `src/features/settings/components/notifications-section.tsx` | ALL | Notification toggles UI - ADD permission request |
| `src/features/settings/actions/settings-actions.ts` | ALL | Settings server actions |
| `src/app/layout.tsx` | ALL | Root layout with PWA metadata - ADD SW registration |
| `next.config.ts` | ALL | Next.js config - WRAP with withSerwist |
| `public/manifest.json` | ALL | PWA manifest - already configured |
| `tsconfig.json` | ALL | TypeScript config - ADD webworker lib |

### New Files to Create

```
public/
â”œâ”€â”€ icons/
â”‚   â”œâ”€â”€ icon-192.png          # PWA icon (192Ã—192)
â”‚   â”œâ”€â”€ icon-512.png          # PWA icon (512Ã—512)
â”‚   â””â”€â”€ apple-touch-icon.png  # iOS home screen icon (180Ã—180)
â”œâ”€â”€ sounds/
â”‚   â””â”€â”€ timer-complete.mp3    # Rest timer completion sound
â””â”€â”€ sw.js                     # Generated by Serwist (gitignored)

src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ sw.ts                 # Service worker source
â”‚   â””â”€â”€ ~offline/
â”‚       â””â”€â”€ page.tsx          # Offline fallback page
â”œâ”€â”€ shared/
â”‚   â””â”€â”€ lib/
â”‚       â””â”€â”€ pwa/
â”‚           â”œâ”€â”€ notifications.ts    # Push notification utilities
â”‚           â””â”€â”€ service-worker.ts   # SW registration helper
â””â”€â”€ components/
    â””â”€â”€ pwa-provider.tsx      # Client component for SW registration
```

### Relevant External Documentation - READ BEFORE IMPLEMENTING

- [Serwist Next.js Getting Started](https://serwist.pages.dev/docs/next/getting-started)
  - Service worker setup with Next.js App Router
  - Why: Required for offline caching and push notifications
- [Next.js PWA Guide](https://nextjs.org/docs/app/guides/progressive-web-apps)
  - Manifest, service worker, and Web Push implementation
  - Why: Official patterns for PWA in Next.js
- [Web Push Notifications MDN](https://developer.mozilla.org/en-US/docs/Web/API/Push_API)
  - Push API and Notification API reference
  - Why: Understanding browser notification capabilities

### Patterns to Follow

**Service Worker Pattern (from Serwist docs):**
```typescript
import { defaultCache } from "@serwist/next/worker";
import type { PrecacheEntry, SerwistGlobalConfig } from "serwist";
import { Serwist } from "serwist";

declare global {
  interface WorkerGlobalScope extends SerwistGlobalConfig {
    __SW_MANIFEST: (PrecacheEntry | string)[] | undefined;
  }
}

const serwist = new Serwist({
  precacheEntries: self.__SW_MANIFEST,
  skipWaiting: true,
  clientsClaim: true,
  navigationPreload: true,
  runtimeCaching: defaultCache,
});

serwist.addEventListeners();
```

**Client Component Pattern (from codebase):**
```typescript
'use client';

import { cn } from '@/shared/lib/utils';

interface Props { /* typed props */ }

export function ComponentName({ className, ...props }: Props) {
  return (
    <div className={cn('base-class', className)}>
      {/* content */}
    </div>
  );
}
```

**Notification Permission Pattern:**
```typescript
// Check support
const isSupported = 'Notification' in window && 'serviceWorker' in navigator;

// Request permission
const permission = await Notification.requestPermission();
if (permission === 'granted') {
  // User allowed notifications
}
```

---

## IMPLEMENTATION PLAN

### Phase 4.1: PWA Infrastructure Setup

Set up Serwist service worker tooling with Next.js 15.

**Tasks:**
- Install @serwist/next and serwist packages
- Configure next.config.ts with withSerwist wrapper
- Update tsconfig.json with webworker types
- Create service worker source file (sw.ts)
- Add .gitignore entries for generated SW files

### Phase 4.2: App Icons & Assets

Create required PWA icons and sound files.

**Tasks:**
- Generate/create app icons (192px, 512px, apple-touch)
- Add timer completion sound file
- Update manifest.json if needed
- Verify assets load correctly

### Phase 4.3: Offline Support

Implement offline fallback page and caching strategy.

**Tasks:**
- Create ~offline fallback page
- Configure Serwist fallback routing
- Test offline behavior
- Ensure critical pages cached

### Phase 4.4: Push Notifications

Implement notification permission flow and rest timer notifications.

**Tasks:**
- Create notification utility functions
- Add permission request to settings toggle
- Integrate notifications with rest timer hook
- Handle notification clicks

### Phase 4.5: Service Worker Registration

Add client-side service worker registration.

**Tasks:**
- Create PWA provider component
- Add to root layout
- Handle registration errors gracefully
- Show install prompt (optional)

### Phase 4.6: UI Polish & Validation

Ensure UI matches design mockups and touch targets are correct.

**Tasks:**
- Compare each screen to design mockups
- Fix any visual discrepancies
- Verify 44Ã—44pt minimum touch targets
- Run Playwright validation scripts

---

## STEP-BY-STEP TASKS

### Task 1: ADD Serwist Dependencies

**IMPLEMENT:** Install PWA packages
```bash
pnpm add @serwist/next && pnpm add -D serwist
```

**VALIDATE:** `pnpm list @serwist/next serwist` - both packages installed

---

### Task 2: UPDATE next.config.ts with Serwist

**IMPLEMENT:** Wrap config with withSerwist
```typescript
import type { NextConfig } from "next";
import withSerwistInit from "@serwist/next";

const withSerwist = withSerwistInit({
  swSrc: "src/app/sw.ts",
  swDest: "public/sw.js",
  disable: process.env.NODE_ENV === "development",
});

const nextConfig: NextConfig = {
  reactStrictMode: true,
  images: {
    formats: ["image/avif", "image/webp"],
    remotePatterns: [],
  },
  experimental: {
    serverActions: {
      bodySizeLimit: "2mb",
    },
  },
};

export default withSerwist(nextConfig);
```

**PATTERN:** MIRROR next.config.ts structure
**GOTCHA:** `disable: true` in development prevents cache issues during dev
**VALIDATE:** `pnpm build` - should complete without errors

---

### Task 3: UPDATE tsconfig.json for Service Worker

**IMPLEMENT:** Add webworker types to compilerOptions
```json
{
  "compilerOptions": {
    "lib": ["dom", "dom.iterable", "esnext", "webworker"],
    "types": ["@serwist/next/typings"]
  },
  "exclude": ["node_modules", "public/sw.js"]
}
```

**GOTCHA:** Must add "webworker" to lib array AND "@serwist/next/typings" to types
**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 4: CREATE Service Worker Source

**IMPLEMENT:** Create `src/app/sw.ts`
```typescript
import { defaultCache } from "@serwist/next/worker";
import type { PrecacheEntry, SerwistGlobalConfig } from "serwist";
import { Serwist } from "serwist";

declare global {
  interface WorkerGlobalScope extends SerwistGlobalConfig {
    __SW_MANIFEST: (PrecacheEntry | string)[] | undefined;
  }
}

declare const self: ServiceWorkerGlobalScope;

const serwist = new Serwist({
  precacheEntries: self.__SW_MANIFEST,
  skipWaiting: true,
  clientsClaim: true,
  navigationPreload: true,
  runtimeCaching: defaultCache,
  fallbacks: {
    entries: [
      {
        url: "/~offline",
        matcher({ request }) {
          return request.destination === "document";
        },
      },
    ],
  },
});

// Handle push notifications
self.addEventListener("push", (event) => {
  const data = event.data?.json() ?? {};
  const title = data.title || "Clean Gains";
  const options: NotificationOptions = {
    body: data.body || "Time to get back to work!",
    icon: "/icons/icon-192.png",
    badge: "/icons/icon-192.png",
    vibrate: [200, 100, 200],
    tag: data.tag || "rest-timer",
    data: data.data || {},
  };

  event.waitUntil(self.registration.showNotification(title, options));
});

// Handle notification clicks
self.addEventListener("notificationclick", (event) => {
  event.notification.close();

  event.waitUntil(
    self.clients.matchAll({ type: "window", includeUncontrolled: true }).then((clientList) => {
      // Focus existing window if available
      for (const client of clientList) {
        if (client.url.includes(self.location.origin) && "focus" in client) {
          return client.focus();
        }
      }
      // Open new window if none exists
      if (self.clients.openWindow) {
        return self.clients.openWindow("/workout");
      }
    })
  );
});

serwist.addEventListeners();
```

**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 5: UPDATE .gitignore for Generated SW Files

**IMPLEMENT:** Add to `.gitignore`
```
# Serwist generated files
public/sw.js
public/sw.js.map
public/swe-worker*.js
```

**VALIDATE:** `cat .gitignore | grep sw` - shows sw entries

---

### Task 6: CREATE Offline Fallback Page

**IMPLEMENT:** Create `src/app/~offline/page.tsx`
```tsx
import { WifiOff } from "lucide-react";

export default function OfflinePage() {
  return (
    <main className="min-h-screen bg-zinc-950 flex flex-col items-center justify-center px-6">
      <div className="w-20 h-20 rounded-full bg-zinc-900 flex items-center justify-center mb-6">
        <WifiOff className="w-10 h-10 text-zinc-500" />
      </div>

      <h1 className="text-2xl font-bold text-white mb-2">You're Offline</h1>

      <p className="text-zinc-400 text-center mb-8 max-w-xs">
        Check your connection and try again. Your workout data is saved locally.
      </p>

      <button
        onClick={() => window.location.reload()}
        className="bg-white text-zinc-950 font-semibold py-3 px-8 rounded-xl hover:bg-zinc-100 transition-colors"
      >
        Try Again
      </button>
    </main>
  );
}
```

**PATTERN:** MIRROR design system colors (zinc-950 background, white button)
**VALIDATE:** Navigate to `/~offline` - should render offline page

---

### Task 7: CREATE App Icons

**IMPLEMENT:** Create placeholder icons (or use real assets if available)

Create `public/icons/` directory and add icon files:
- `icon-192.png` (192Ã—192) - Emerald dumbbell on dark background
- `icon-512.png` (512Ã—512) - Same design, larger
- `apple-touch-icon.png` (180Ã—180) - For iOS home screen

**Icon Design Spec (from Brand Guidelines):**
- Background: #09090b (zinc-950)
- Accent: #10b981 (emerald-500)
- Simple geometric dumbbell or "CG" lettermark

For MVP, create simple placeholder icons:
```bash
mkdir -p public/icons
# Generate simple icons using ImageMagick or similar tool
# Or use a placeholder service temporarily
```

**GOTCHA:** Icons MUST exist for manifest to work - even placeholder PNGs
**VALIDATE:** `ls public/icons/` - shows icon-192.png, icon-512.png, apple-touch-icon.png

---

### Task 8: CREATE Timer Completion Sound

**IMPLEMENT:** Add sound file to `public/sounds/`

Create or source a short (1-2 second) notification sound:
- Format: MP3 (best browser compatibility)
- Style: Short, attention-grabbing but not jarring
- Volume: Normalized, not too loud

```bash
# Remove .gitkeep and add actual sound file
rm public/sounds/.gitkeep
# Add timer-complete.mp3 to public/sounds/
```

**GOTCHA:** iOS requires user interaction before audio can play - this is already handled in use-rest-timer.ts
**VALIDATE:** Audio file exists at `public/sounds/timer-complete.mp3`

---

### Task 9: UPDATE manifest.json with Apple Icons

**IMPLEMENT:** Update `public/manifest.json`
```json
{
  "name": "Clean Gains",
  "short_name": "Clean Gains",
  "description": "Personal workout tracker for Push/Pull/Legs",
  "start_url": "/",
  "display": "standalone",
  "background_color": "#09090b",
  "theme_color": "#09090b",
  "orientation": "portrait",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "maskable"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "maskable"
    }
  ]
}
```

**GOTCHA:** Separate entries for "any" and "maskable" purpose (not combined)
**VALIDATE:** `curl localhost:3000/manifest.json | jq .icons` - shows 4 icon entries

---

### Task 10: CREATE Notification Utilities

**IMPLEMENT:** Create `src/shared/lib/pwa/notifications.ts`
```typescript
/**
 * PWA Notification utilities for Clean Gains
 */

export interface NotificationOptions {
  title: string;
  body: string;
  tag?: string;
  data?: Record<string, unknown>;
}

/**
 * Check if notifications are supported in the current browser
 */
export function isNotificationSupported(): boolean {
  return typeof window !== "undefined" &&
    "Notification" in window &&
    "serviceWorker" in navigator;
}

/**
 * Get current notification permission status
 */
export function getNotificationPermission(): NotificationPermission | "unsupported" {
  if (!isNotificationSupported()) return "unsupported";
  return Notification.permission;
}

/**
 * Request notification permission from user
 * @returns The permission result
 */
export async function requestNotificationPermission(): Promise<NotificationPermission | "unsupported"> {
  if (!isNotificationSupported()) return "unsupported";

  try {
    const permission = await Notification.requestPermission();
    return permission;
  } catch (error) {
    console.error("Error requesting notification permission:", error);
    return "denied";
  }
}

/**
 * Show a notification via the service worker
 * Falls back to Notification API if SW not available
 */
export async function showNotification(options: NotificationOptions): Promise<boolean> {
  if (!isNotificationSupported()) return false;

  const permission = getNotificationPermission();
  if (permission !== "granted") return false;

  try {
    const registration = await navigator.serviceWorker.ready;

    await registration.showNotification(options.title, {
      body: options.body,
      icon: "/icons/icon-192.png",
      badge: "/icons/icon-192.png",
      vibrate: [200, 100, 200],
      tag: options.tag || "clean-gains",
      data: options.data,
    });

    return true;
  } catch (error) {
    console.error("Error showing notification:", error);

    // Fallback to Notification API
    try {
      new Notification(options.title, {
        body: options.body,
        icon: "/icons/icon-192.png",
        tag: options.tag,
      });
      return true;
    } catch {
      return false;
    }
  }
}

/**
 * Show rest timer completion notification
 */
export async function showRestCompleteNotification(): Promise<boolean> {
  return showNotification({
    title: "Rest Complete",
    body: "Time to get back to work! ðŸ’ª",
    tag: "rest-timer",
    data: { type: "rest-complete" },
  });
}
```

**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 11: CREATE Service Worker Registration Helper

**IMPLEMENT:** Create `src/shared/lib/pwa/service-worker.ts`
```typescript
/**
 * Service Worker registration utilities
 */

export interface SWRegistrationResult {
  success: boolean;
  registration?: ServiceWorkerRegistration;
  error?: string;
}

/**
 * Register the service worker
 */
export async function registerServiceWorker(): Promise<SWRegistrationResult> {
  if (typeof window === "undefined" || !("serviceWorker" in navigator)) {
    return { success: false, error: "Service workers not supported" };
  }

  try {
    const registration = await navigator.serviceWorker.register("/sw.js", {
      scope: "/",
    });

    // Check for updates
    registration.addEventListener("updatefound", () => {
      const newWorker = registration.installing;
      if (newWorker) {
        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            // New version available
            console.log("New version of Clean Gains available");
          }
        });
      }
    });

    return { success: true, registration };
  } catch (error) {
    console.error("Service worker registration failed:", error);
    return {
      success: false,
      error: error instanceof Error ? error.message : "Registration failed"
    };
  }
}

/**
 * Check if service worker is ready
 */
export async function getServiceWorkerRegistration(): Promise<ServiceWorkerRegistration | null> {
  if (typeof window === "undefined" || !("serviceWorker" in navigator)) {
    return null;
  }

  try {
    return await navigator.serviceWorker.ready;
  } catch {
    return null;
  }
}
```

**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 12: CREATE PWA Provider Component

**IMPLEMENT:** Create `src/shared/components/pwa-provider.tsx`
```tsx
"use client";

import { useEffect } from "react";
import { registerServiceWorker } from "@/shared/lib/pwa/service-worker";

export function PWAProvider({ children }: { children: React.ReactNode }) {
  useEffect(() => {
    // Only register in production
    if (process.env.NODE_ENV === "production") {
      registerServiceWorker().then((result) => {
        if (result.success) {
          console.log("Service worker registered successfully");
        }
      });
    }
  }, []);

  return <>{children}</>;
}
```

**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 13: UPDATE Root Layout with PWA Provider

**IMPLEMENT:** Update `src/app/layout.tsx`
```tsx
import type { Metadata, Viewport } from "next";
import { Inter } from "next/font/google";
import { PWAProvider } from "@/shared/components/pwa-provider";
import "./globals.css";

const inter = Inter({
  subsets: ["latin"],
  display: "swap",
  variable: "--font-inter",
});

export const metadata: Metadata = {
  title: "Clean Gains",
  description: "Personal workout tracker for Push/Pull/Legs",
  manifest: "/manifest.json",
  appleWebApp: {
    capable: true,
    statusBarStyle: "black-translucent",
    title: "Clean Gains",
  },
  icons: {
    apple: "/icons/apple-touch-icon.png",
  },
};

export const viewport: Viewport = {
  width: "device-width",
  initialScale: 1,
  maximumScale: 1,
  userScalable: false,
  viewportFit: "cover",
  themeColor: "#09090b",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en" className="dark">
      <body
        className={`${inter.variable} font-sans antialiased bg-background text-foreground min-h-screen`}
      >
        <PWAProvider>{children}</PWAProvider>
      </body>
    </html>
  );
}
```

**PATTERN:** MIRROR existing layout structure, ADD PWAProvider wrapper
**VALIDATE:** `pnpm build` - should complete without errors

---

### Task 14: UPDATE use-rest-timer Hook with Notifications

**IMPLEMENT:** Update `src/features/workout/hooks/use-rest-timer.ts`
```typescript
"use client";

import { useState, useEffect, useCallback, useRef } from "react";
import {
  showRestCompleteNotification,
  getNotificationPermission
} from "@/shared/lib/pwa/notifications";

interface Options {
  defaultRestSeconds: number;
  onComplete?: () => void;
  soundEnabled?: boolean;
  vibrationEnabled?: boolean;
  notificationsEnabled?: boolean;
}

export function useRestTimer({
  defaultRestSeconds,
  onComplete,
  soundEnabled = true,
  vibrationEnabled = true,
  notificationsEnabled = false,
}: Options) {
  const [isActive, setIsActive] = useState(false);
  const [remainingSeconds, setRemainingSeconds] = useState(0);
  const [totalSeconds, setTotalSeconds] = useState(defaultRestSeconds);
  const audioRef = useRef<HTMLAudioElement | null>(null);

  useEffect(() => {
    if (typeof window !== "undefined") {
      audioRef.current = new Audio("/sounds/timer-complete.mp3");
    }
  }, []);

  useEffect(() => {
    if (!isActive || remainingSeconds <= 0) return;

    const interval = setInterval(() => {
      setRemainingSeconds((prev) => {
        if (prev <= 1) {
          setIsActive(false);

          // Play sound
          if (soundEnabled) {
            audioRef.current?.play().catch(() => {});
          }

          // Vibrate
          if (vibrationEnabled && navigator.vibrate) {
            navigator.vibrate([200, 100, 200]);
          }

          // Show notification (if enabled and permitted)
          if (notificationsEnabled && getNotificationPermission() === "granted") {
            showRestCompleteNotification();
          }

          onComplete?.();
          return 0;
        }
        return prev - 1;
      });
    }, 1000);

    return () => clearInterval(interval);
  }, [isActive, remainingSeconds, soundEnabled, vibrationEnabled, notificationsEnabled, onComplete]);

  const start = useCallback((customSeconds?: number) => {
    const s = customSeconds ?? defaultRestSeconds;
    setTotalSeconds(s);
    setRemainingSeconds(s);
    setIsActive(true);
  }, [defaultRestSeconds]);

  const formatTime = (s: number) => `${Math.floor(s / 60)}:${(s % 60).toString().padStart(2, "0")}`;

  return {
    isActive,
    remainingSeconds,
    formattedTime: formatTime(remainingSeconds),
    progress: totalSeconds > 0 ? ((totalSeconds - remainingSeconds) / totalSeconds) * 100 : 0,
    start,
    skip: useCallback(() => { setIsActive(false); setRemainingSeconds(0); }, []),
  };
}
```

**PATTERN:** MIRROR existing hook structure, ADD notifications parameter
**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 15: UPDATE Notifications Section with Permission Request

**IMPLEMENT:** Update `src/features/settings/components/notifications-section.tsx`
```tsx
"use client";

import { useState, useEffect } from "react";
import { Switch } from "@/shared/components/ui/switch";
import { updateUserSettings } from "../actions/settings-actions";
import {
  isNotificationSupported,
  getNotificationPermission,
  requestNotificationPermission
} from "@/shared/lib/pwa/notifications";

interface Props {
  workoutRemindersEnabled: boolean;
  restDayAlertsEnabled: boolean;
}

export function NotificationsSection({
  workoutRemindersEnabled: initialWorkoutReminders,
  restDayAlertsEnabled: initialRestDayAlerts
}: Props) {
  const [workoutReminders, setWorkoutReminders] = useState(initialWorkoutReminders);
  const [restDayAlerts, setRestDayAlerts] = useState(initialRestDayAlerts);
  const [notificationPermission, setNotificationPermission] = useState<string>("default");
  const [isSupported, setIsSupported] = useState(true);

  useEffect(() => {
    setIsSupported(isNotificationSupported());
    setNotificationPermission(getNotificationPermission());
  }, []);

  const handleWorkoutRemindersChange = async (enabled: boolean) => {
    // Request permission if enabling and not yet granted
    if (enabled && notificationPermission !== "granted") {
      const permission = await requestNotificationPermission();
      setNotificationPermission(permission);

      if (permission !== "granted") {
        // User denied - don't enable the setting
        return;
      }
    }

    setWorkoutReminders(enabled);
    await updateUserSettings({ workout_reminders_enabled: enabled });
  };

  const handleRestDayAlertsChange = async (enabled: boolean) => {
    // Request permission if enabling and not yet granted
    if (enabled && notificationPermission !== "granted") {
      const permission = await requestNotificationPermission();
      setNotificationPermission(permission);

      if (permission !== "granted") {
        return;
      }
    }

    setRestDayAlerts(enabled);
    await updateUserSettings({ rest_day_alerts_enabled: enabled });
  };

  if (!isSupported) {
    return (
      <div>
        <h2 className="text-xs font-medium text-zinc-400 uppercase tracking-wide mb-3">
          NOTIFICATIONS
        </h2>
        <div className="bg-zinc-900 rounded-2xl p-5">
          <p className="text-zinc-500 text-sm">
            Notifications are not supported in this browser.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div>
      <h2 className="text-xs font-medium text-zinc-400 uppercase tracking-wide mb-3">
        NOTIFICATIONS
      </h2>
      <div className="bg-zinc-900 rounded-2xl divide-y divide-zinc-800">
        <div className="flex items-center justify-between px-5 py-4">
          <div>
            <span className="text-white">Workout Reminders</span>
            {notificationPermission === "denied" && (
              <p className="text-xs text-red-500 mt-1">
                Notifications blocked in browser settings
              </p>
            )}
          </div>
          <Switch
            checked={workoutReminders}
            onCheckedChange={handleWorkoutRemindersChange}
            disabled={notificationPermission === "denied"}
            className="data-[state=checked]:bg-emerald-500"
          />
        </div>
        <div className="flex items-center justify-between px-5 py-4">
          <div>
            <span className="text-white">Rest Day Alerts</span>
          </div>
          <Switch
            checked={restDayAlerts}
            onCheckedChange={handleRestDayAlertsChange}
            disabled={notificationPermission === "denied"}
            className="data-[state=checked]:bg-emerald-500"
          />
        </div>
      </div>
    </div>
  );
}
```

**PATTERN:** MIRROR existing settings section pattern
**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 16: CREATE PWA Library Index Export

**IMPLEMENT:** Create `src/shared/lib/pwa/index.ts`
```typescript
export * from "./notifications";
export * from "./service-worker";
```

**VALIDATE:** `pnpm typecheck` - should pass

---

### Task 17: VALIDATE Touch Target Sizes

**IMPLEMENT:** Review and fix any buttons/links < 44Ã—44pt

Key areas to check:
- Home page: START WORKOUT button (already 56px height âœ“)
- Workout: Set checkboxes, navigation arrows
- Settings: Toggle switches (ensure padding)
- Bottom nav: Tab items

Add minimum sizing to small interactive elements:
```tsx
// Example fix for small buttons
<button className="min-w-[44px] min-h-[44px] ...">
```

**VALIDATE:** Run Playwright touch target validation:
```javascript
browser_evaluate({
  function: `() => {
    const btns = document.querySelectorAll('button, a, [role="button"]');
    return [...btns].filter(b => {
      const r = b.getBoundingClientRect();
      return r.width < 44 || r.height < 44;
    }).length;
  }`
})
// Expected: 0
```

---

### Task 18: VALIDATE UI Against Design Mockups

**IMPLEMENT:** Compare each screen to mockups and fix discrepancies

| Screen | Mockup File | Key Elements to Verify |
|--------|-------------|------------------------|
| Home | `design-assets/ui-screens/home-screen-ui.png` | Hero gradient, card border radius, button style |
| Workout | `design-assets/ui-screens/active-workout-ui.png` | Set table layout, timer bar |
| Summary | `design-assets/ui-screens/post-workout-summary.png` | T-Rex image, stats icons |
| Progress | `design-assets/ui-screens/progress-dashboard.png` | PR cards, chart, bottom nav |
| Settings | `design-assets/ui-screens/settings-ui.png` | Section headers, toggle styling |

**VALIDATE:** Take screenshots and compare:
```javascript
browser_resize({ width: 430, height: 932 })
browser_navigate({ url: "http://localhost:3000" })
browser_take_screenshot({ filename: "final-home.png" })
// Compare to design-assets/ui-screens/home-screen-ui.png
```

---

### Task 19: PRODUCTION BUILD Test

**IMPLEMENT:** Run full production build and verify PWA functionality
```bash
pnpm build
pnpm start
```

**VALIDATE:**
1. Visit `http://localhost:3000` in Chrome
2. Open DevTools > Application > Service Workers - should show registered SW
3. Open DevTools > Application > Manifest - should show app info with icons
4. Check "Install" option appears in browser address bar

---

## TESTING STRATEGY

### Unit Tests

Test notification utility functions:
```typescript
// src/shared/lib/pwa/__tests__/notifications.test.ts
describe("notifications", () => {
  it("returns unsupported when Notification API missing", () => {
    expect(getNotificationPermission()).toBe("unsupported");
  });
});
```

### Integration Tests

Test service worker registration in production build:
```bash
pnpm build && pnpm start
# Navigate to app, check SW registered in DevTools
```

### Edge Cases

- Notification permission denied - toggle should show blocked message
- Offline mode - fallback page should display
- iOS Safari PWA - verify audio plays after user interaction
- Service worker update - verify new version installs

---

## VALIDATION COMMANDS

### Level 1: Syntax & Style

```bash
# TypeScript type checking
pnpm typecheck

# ESLint
pnpm lint

# Build check
pnpm build
```

**Expected:** All pass with exit code 0

### Level 2: PWA Manifest Validation

```bash
# Start server and check manifest
pnpm build && pnpm start &
sleep 5
curl -s http://localhost:3000/manifest.json | jq .
```

**Expected:** Valid JSON with name, icons, display mode

### Level 3: Service Worker Validation

```javascript
// In browser console on production build
navigator.serviceWorker.ready.then(r => console.log(r.active ? 'SW Active' : 'SW Pending'))
```

**Expected:** "SW Active"

### Level 4: Visual Regression

```javascript
// Playwright MCP validation
browser_resize({ width: 430, height: 932 })
browser_navigate({ url: "http://localhost:3000" })
browser_take_screenshot({ filename: "final-home.png", fullPage: true })
browser_navigate({ url: "http://localhost:3000/workout" })
browser_take_screenshot({ filename: "final-workout.png", fullPage: true })
browser_navigate({ url: "http://localhost:3000/progress" })
browser_take_screenshot({ filename: "final-progress.png", fullPage: true })
browser_navigate({ url: "http://localhost:3000/settings" })
browser_take_screenshot({ filename: "final-settings.png", fullPage: true })
```

### Level 5: Touch Target Validation

```javascript
browser_evaluate({
  function: `() => {
    const btns = document.querySelectorAll('button, a, [role="button"], input, [tabindex]');
    const small = [...btns].filter(b => {
      const r = b.getBoundingClientRect();
      return r.width > 0 && r.height > 0 && (r.width < 44 || r.height < 44);
    });
    return small.map(b => ({ tag: b.tagName, class: b.className, size: b.getBoundingClientRect() }));
  }`
})
```

**Expected:** Empty array (no undersized targets)

---

## ACCEPTANCE CRITERIA

- [ ] @serwist/next installed and configured
- [ ] Service worker builds and registers in production
- [ ] App icons exist (192px, 512px, apple-touch)
- [ ] Timer completion sound plays when rest ends
- [ ] Offline fallback page displays when offline
- [ ] Notification permission requested on toggle enable
- [ ] Rest timer shows notification when complete (if permitted)
- [ ] PWA installable on iPhone 16 Pro Max
- [ ] All touch targets â‰¥ 44Ã—44pt
- [ ] UI matches design mockups
- [ ] Build passes without errors
- [ ] Type checking passes without errors

---

## COMPLETION CHECKLIST

- [ ] All tasks completed in order
- [ ] Each task validation passed immediately
- [ ] All validation commands executed successfully:
  - [ ] Level 1: typecheck, lint, build
  - [ ] Level 2: manifest.json valid
  - [ ] Level 3: service worker active
  - [ ] Level 4: screenshots captured
  - [ ] Level 5: no undersized touch targets
- [ ] PWA installable from browser
- [ ] Offline page shows when disconnected
- [ ] Notifications work when enabled
- [ ] All acceptance criteria met

---

## NOTES

### Design Decisions

1. **Serwist over next-pwa**: Serwist is actively maintained and officially recommended by Next.js docs. next-pwa is abandoned.

2. **Disable SW in Development**: Prevents cache issues during development that cause stale content.

3. **Notification Fallback**: Shows browser Notification API if SW notification fails, ensuring broader compatibility.

4. **Separate Icon Purposes**: Manifest has separate entries for "any" and "maskable" purposes per PWA best practices.

### Risk Considerations

1. **iOS PWA Limitations**: iOS Safari has limited push notification support (iOS 16.4+). The in-app sound/vibration fallback handles older iOS versions.

2. **Next.js 15 + Serwist**: Some users report issues - may need to pin @serwist/next version if problems occur.

3. **Audio on iOS**: Audio requires prior user interaction. The timer audio will only play after user has interacted with the workout page.

### Dependencies

- @serwist/next: Service worker integration
- serwist: Core service worker utilities
- App icons: Need to be created or sourced (placeholder acceptable for MVP)
- Timer sound: Need to source or create an MP3 file

### iOS-Specific Considerations

For best iOS PWA experience:
- `apple-touch-icon.png` at 180Ã—180
- `statusBarStyle: "black-translucent"` in metadata
- `viewportFit: "cover"` for notch handling
- Sound/vibration as primary notification (push notifications limited)
